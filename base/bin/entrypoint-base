#!/usr/bin/env bash

set -euo pipefail

PROFILE=config/profile

# If a pseudo TTY is allocated, we are assuming an interactive shell
if [[ -t 0 ]]
then
  if [[ -f "${PROFILE}" ]]
  then
    source "${PROFILE}"
  else
    echo "File '${PROFILE}' not found!" >&2
  fi

  "${@}"
else
  source "${PROFILE}"

  if can-sudo
  then
    # Make sure everything in home is owned by app
    recapture-dir "${HOME}" 2>/dev/null || true
    recapture-dir /output 2>/dev/null || true
    # Remove the sudoers file to avoid privilge escalation
    giveup-sudo
  fi

  typeset -r SCRIPT="${1}"; shift
  # Keep colors by running the command with script and handle the output
  script /dev/null -eqc "${SCRIPT} ${*}" | log "${SCRIPT}"
fi
