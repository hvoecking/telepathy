#!/usr/bin/env bash

###
# @license
# Heye VÃ¶cking All Rights Reserved.
#
# Use of this source code is governed by an MIT-style license that can be
# found in the LICENSE file at https://telepathy.app/license
##

set -euo pipefail

fusemount() {
  local BUCKET=$1; shift
  local MOUNT_POINT=$1; shift
  if mount | grep "$BUCKET on $MOUNT_POINT type fuse" >/dev/null
  then
    return
  fi
  mkdir -p "$MOUNT_POINT"
  gcsfuse "$BUCKET" "$MOUNT_POINT"
}

caddy_configure() {
  fusemount acme.caddy.telepathy.app "$CADDYPATH/acme"

  cat << EOF > "$CADDYPATH/Caddyfile"
telepathy.app {
  tls webmaster@telepathy.app
  gzip
  cors
  cache
  root $PWD/telepathy.app/
}
EOF
}

caddy_daemon() {
  echo "starting caddy..."
  /usr/local/bin/caddy \
    -log stdout \
    -agree=true \
    -conf="$CADDYPATH/Caddyfile" \
    -root=/var/tmp \
  ;
}

main() {
  caddy_configure
  caddy_daemon
}

main
